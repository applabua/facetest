<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width,initial-scale=1.0,user-scalable=no">
  <title>Eye-Control с Калибровкой</title>
  <style>
    html, body {
      margin:0; padding:0;
      width:100%; height:100%; overflow:hidden;
      background:#000; position:relative;
    }
    /* Видео и оверлей лица на весь экран */
    #webgazerVideoFeed, #webgazerFaceOverlay {
      position:absolute!important;
      top:0; left:0!important;
      width:100vw!important; height:100vh!important;
      transform:none!important;
      pointer-events:none; z-index:1;
    }
    /* Скрываем точки WebGazer */
    .webgazerPredictionPoint { display:none!important; }

    /* Точка взгляда */
    #dot {
      position:absolute;
      width:20px; height:20px;
      margin:-10px 0 0 -10px;
      border-radius:50%; background:lime;
      pointer-events:none; z-index:10;
      will-change:transform;
    }
    /* Кнопка */
    #actionBtn {
      position:absolute;
      bottom:40px; left:50%;
      transform:translateX(-50%);
      padding:15px 30px; font-size:18px;
      border:none; border-radius:8px;
      background:#1e90ff; color:#fff; z-index:5;
      user-select:none;
    }
    /* Калибровочные точки */
    .cal-point {
      position:absolute;
      width:20px; height:20px;
      margin:-10px 0 0 -10px;
      background:#f00; border-radius:50%;
      z-index:20; cursor:pointer;
    }
    #cal-status {
      position:absolute; top:10px; left:50%;
      transform:translateX(-50%);
      color:#fff; font-size:18px; z-index:21;
      user-select:none;
    }
  </style>
</head>
<body>
  <div id="cal-status">Калибровка: кликните по всем 9 точкам</div>
  <button id="actionBtn" style="display:none">Нажми меня взглядом</button>
  <div id="dot" style="display:none"></div>

  <script src="https://webgazer.cs.brown.edu/webgazer.js"></script>
  <script>
    document.addEventListener('DOMContentLoaded', () => {
      const BUFFER_SIZE     = 4;
      const BLINK_THRESHOLD = 0.22;
      const BLINK_DEBOUNCE  = 500;
      const INVERT_X        = true;  // инверсия по X, чтобы убрать «зеркальность»

      let gazeX  = window.innerWidth/2;
      let gazeY  = window.innerHeight/2;
      let buffer = [];
      let lastBlink = 0;
      let calStep = 0;
      const calPoints = [
        [0.1,0.1],[0.5,0.1],[0.9,0.1],
        [0.1,0.5],[0.5,0.5],[0.9,0.5],
        [0.1,0.9],[0.5,0.9],[0.9,0.9]
      ];

      const statusEl = document.getElementById('cal-status');
      const btn = document.getElementById('actionBtn');
      const dot = document.getElementById('dot');

      // Создаём и показываем калибровочные точки
      function showNextPoint() {
        if (calStep >= calPoints.length) return finishCalibration();
        const [rx, ry] = calPoints[calStep];
        const p = document.createElement('div');
        p.className = 'cal-point';
        p.style.left = (rx*100) + 'vw';
        p.style.top  = (ry*100) + 'vh';
        p.addEventListener('click', e => {
          webgazer.recordScreenPosition(e.clientX, e.clientY, 'cal');
          p.remove(); calStep++;
          statusEl.textContent = `Калибровка: ${calStep}/${calPoints.length}`;
          showNextPoint();
        });
        document.body.append(p);
      }

      function finishCalibration() {
        statusEl.textContent = 'Калибровка завершена!';
        setTimeout(() => statusEl.style.display = 'none', 1000);
        // очищаем избыточные данные и включаем фильтр
        webgazer.clearData();
        webgazer.applyKalmanFilter(true);

        // показываем интерфейс
        btn.style.display = 'block';
        dot.style.display = 'block';
        requestAnimationFrame(animate);
      }

      // Анимация точки и blink-click
      function animate(ts) {
        // Усредняем
        buffer.push({x:gazeX,y:gazeY});
        if (buffer.length>BUFFER_SIZE) buffer.shift();
        const sum = buffer.reduce((p,c)=>({x:p.x+c.x,y:p.y+c.y}),{x:0,y:0});
        const avgX = sum.x/buffer.length, avgY = sum.y/buffer.length;
        dot.style.transform = `translate(${avgX}px,${avgY}px)`;

        // Blink-click по обоим глазам
        const tracker = webgazer.getTracker();
        if (tracker) {
          const pts = tracker.getCurrentPosition();
          if (pts && pts.length>33) {
            const eyes = [
              {o:pts[23],i:pts[25],t:pts[24],b:pts[26]},
              {o:pts[30],i:pts[32],t:pts[31],b:pts[33]}
            ];
            const ears = eyes.map(e=>{
              const w=Math.hypot(e.o[0]-e.i[0],e.o[1]-e.i[1]);
              const h=Math.hypot(e.t[0]-e.b[0],e.t[1]-e.b[1]);
              return h/w;
            });
            const ear = Math.min(...ears);
            const now = performance.now();
            if (ear<BLINK_THRESHOLD && now-lastBlink>BLINK_DEBOUNCE) {
              lastBlink = now;
              const r=btn.getBoundingClientRect();
              if (avgX>=r.left && avgX<=r.right && avgY>=r.top && avgY<=r.bottom) {
                btn.click();
              }
            }
          }
        }
        requestAnimationFrame(animate);
      }

      // Инициализация WebGazer
      webgazer.setRegression('ridge')
              .setTracker('clmtrackr')
              .setGazeListener(data=>{
                if (!data) return;
                const x = INVERT_X ? window.innerWidth - data.x : data.x;
                gazeX = x; gazeY = data.y;
              })
              .begin()
              .then(()=>{
                webgazer.showVideo(true);
                webgazer.showFaceOverlay(true);
                webgazer.showPredictionPoints(false);
                showNextPoint();
              })
              .catch(err=>console.error(err));

      // Отклик на клик
      btn.addEventListener('click',()=>{
        btn.textContent='Нажато!';
        setTimeout(()=>btn.textContent='Нажми меня взглядом',800);
      });
    });
  </script>
</body>
</html>
