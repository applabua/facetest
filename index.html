<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width,initial-scale=1.0,user-scalable=no">
  <title>Eye-Control с корректным превью и счётчиком</title>
  <style>
    html, body {
      margin:0; padding:0;
      width:100%; height:100%; overflow:hidden;
      background:#000; position:relative;
      font-family:sans-serif;
    }

    /* Скрываем WebGazer-превью до калибровки */
    #webgazerVideoFeed,
    #webgazerFaceOverlay {
      display: none !important;
    }
    .webgazerPredictionPoint { display: none !important; }

    /* Красная точка калибровки */
    .cal-point {
      position:absolute;
      width:20px; height:20px;
      margin:-10px 0 0 -10px;
      background:#f00; border-radius:50%;
      z-index:100; cursor:pointer;
    }
    #cal-status {
      position:absolute; top:10px; left:50%;
      transform:translateX(-50%);
      color:#fff; font-size:18px; z-index:100;
      user-select:none;
    }

    /* Точка взгляда */
    #dot {
      position:absolute;
      width:20px; height:20px;
      margin:-10px 0 0 -10px;
      border-radius:50%; background:lime;
      pointer-events:none; z-index:50;
      will-change:transform;
      display:none;
    }

    /* Кнопка клика */
    #actionBtn {
      position:absolute;
      bottom:80px; left:50%;
      transform:translateX(-50%);
      padding:15px 30px; font-size:18px;
      border:none; border-radius:8px;
      background:#1e90ff; color:#fff;
      z-index:50; user-select:none;
      display:none;
    }

    /* Счётчик кликов */
    #clickCounter {
      position:absolute;
      bottom:40px; left:50%;
      transform:translateX(-50%);
      color:#fff; font-size:16px;
      z-index:50; display:none;
    }
  </style>
</head>
<body>
  <div id="cal-status">Калибровка: кликните по всем 9 точкам</div>
  <button id="actionBtn">Нажми меня взглядом</button>
  <div id="dot"></div>
  <div id="clickCounter">Кликов: 0</div>

  <script src="https://webgazer.cs.brown.edu/webgazer.js"></script>
  <script>
    document.addEventListener('DOMContentLoaded', () => {
      // Параметры
      const BUFFER_SIZE     = 4;
      const BLINK_THRESHOLD = 0.22;
      const BLINK_DEBOUNCE  = 500;
      const INVERT_X        = true;

      // Состояние
      let gazeX = window.innerWidth/2;
      let gazeY = window.innerHeight/2;
      let buffer = [];
      let lastBlink = 0;
      let calStep = 0;
      let clickCount = 0;

      // 9 точек калибровки (в % ширины/высоты)
      const calPoints = [
        [0.1,0.1],[0.5,0.1],[0.9,0.1],
        [0.1,0.5],[0.5,0.5],[0.9,0.5],
        [0.1,0.9],[0.5,0.9],[0.9,0.9]
      ];

      const statusEl = document.getElementById('cal-status');
      const btn      = document.getElementById('actionBtn');
      const dot      = document.getElementById('dot');
      const counter  = document.getElementById('clickCounter');

      // Рисуем калибровочные точки одну за другой
      function showNextPoint() {
        if (calStep >= calPoints.length) return finishCalibration();
        const [rx, ry] = calPoints[calStep];
        const p = document.createElement('div');
        p.className = 'cal-point';
        p.style.left = (rx*100) + 'vw';
        p.style.top  = (ry*100) + 'vh';
        p.addEventListener('click', e => {
          // записываем калибр. позицию
          webgazer.recordScreenPosition(e.clientX, e.clientY, 'cal');
          p.remove();
          calStep++;
          statusEl.textContent = `Калибровка: ${calStep}/${calPoints.length}`;
          showNextPoint();
        });
        document.body.append(p);
      }

      // Завершаем калибровку
      function finishCalibration() {
        statusEl.textContent = 'Калибровка завершена!';
        setTimeout(() => statusEl.style.display = 'none', 1000);

        // Очищаем шум и включаем Kalman-фильтр
        webgazer.clearData();
        webgazer.applyKalmanFilter(true);

        // Появляется интерфейс управления
        btn.style.display = 'block';
        dot.style.display = 'block';
        counter.style.display = 'block';

        // Размер и позиция мини-превью
        const video  = document.getElementById('webgazerVideoFeed');
        const overlay= document.getElementById('webgazerFaceOverlay');
        [video, overlay].forEach(el => {
          el.style.display       = 'block';
          el.style.position      = 'absolute';
          el.style.width         = '160px';
          el.style.height        = '120px';
          el.style.top           = '10px';
          el.style.left          = '10px';
          el.style.transform     = 'none';
          el.style.pointerEvents = 'none';
          el.style.zIndex        = '50';
        });
        // рамка только вокруг видео
        video.style.border       = '2px solid #0f0';
        video.style.borderRadius = '4px';

        requestAnimationFrame(animate);
      }

      // Основной цикл: позиция точки и blink-click
      function animate(ts) {
        // усредняем последние позиции
        buffer.push({x:gazeX,y:gazeY});
        if (buffer.length > BUFFER_SIZE) buffer.shift();
        const sum = buffer.reduce((p,c)=>({x:p.x+c.x,y:p.y+c.y}),{x:0,y:0});
        const avgX = sum.x / buffer.length;
        const avgY = sum.y / buffer.length;
        dot.style.transform = `translate(${avgX}px,${avgY}px)`;

        // моргание по двум глазам
        const tracker = webgazer.getTracker();
        if (tracker) {
          const pts = tracker.getCurrentPosition();
          if (pts && pts.length > 33) {
            const eyes = [
              {o:pts[23], i:pts[25], t:pts[24], b:pts[26]},
              {o:pts[30], i:pts[32], t:pts[31], b:pts[33]}
            ];
            const ears = eyes.map(e=>{
              const w = Math.hypot(e.o[0]-e.i[0], e.o[1]-e.i[1]);
              const h = Math.hypot(e.t[0]-e.b[0], e.t[1]-e.b[1]);
              return h / w;
            });
            const ear = Math.min(...ears);
            const now = performance.now();
            if (ear < BLINK_THRESHOLD && (now - lastBlink) > BLINK_DEBOUNCE) {
              lastBlink = now;
              const r = btn.getBoundingClientRect();
              if (avgX >= r.left && avgX <= r.right && avgY >= r.top && avgY <= r.bottom) {
                btn.click();
              }
            }
          }
        }
        requestAnimationFrame(animate);
      }

      // Инициализация WebGazer
      webgazer.setRegression('ridge')
              .setTracker('clmtrackr')
              .setGazeListener(data => {
                if (!data) return;
                // убираем «зеркальный» X, если нужно
                gazeX = INVERT_X ? window.innerWidth - data.x : data.x;
                gazeY = data.y;
              })
              .begin()
              .then(() => {
                // калибровочный цикл стартует после инициализации
                showNextPoint();
              })
              .catch(err => console.error('WebGazer init error:', err));

      // Обработка «кликов глазами»
      btn.addEventListener('click', () => {
        clickCount++;
        counter.textContent = `Кликов: ${clickCount}`;
        btn.textContent = 'Нажато!';
        setTimeout(() => btn.textContent = 'Нажми меня взглядом', 800);
      });
    });
  </script>
</body>
</html>
