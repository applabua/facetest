<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0,user-scalable=no"/>
  <title>Молниеносное Eye-Control</title>
  <style>
    html, body {
      margin: 0; padding: 0;
      width: 100%; height: 100%; overflow: hidden;
      background: #000;
      position: relative;
    }
    /* Скрываем все оверлеи WebGazer для производительности */
    #webgazerVideoFeed,
    #webgazerFaceOverlay,
    .webgazerPredictionPoint {
      display: none !important;
    }
    /* Наша «точка взгляда» */
    #dot {
      position: absolute;
      width: 20px; height: 20px;
      margin: -10px 0 0 -10px;
      border-radius: 50%;
      background: lime;
      pointer-events: none;
      z-index: 10;
      will-change: transform;
    }
    /* Кнопка */
    #actionBtn {
      position: absolute;
      bottom: 40px;
      left: 50%;
      transform: translateX(-50%);
      padding: 15px 30px;
      font-size: 18px;
      border: none;
      border-radius: 8px;
      background: #1e90ff;
      color: #fff;
      z-index: 5;
      user-select: none;
    }
  </style>
</head>
<body>
  <button id="actionBtn">Нажми меня взглядом</button>
  <div id="dot"></div>

  <script src="https://webgazer.cs.brown.edu/webgazer.js"></script>
  <script>
    document.addEventListener('DOMContentLoaded', () => {
      const dot = document.getElementById('dot');
      const btn = document.getElementById('actionBtn');

      // Параметры
      const BUFFER_SIZE       = 4;      // усреднение — меньше буфера = меньше задержка
      const BLINK_THRESHOLD   = 0.18;   // порог отношения высоты к ширине глаза
      const BLINK_DEBOUNCE    = 500;    // минимальный интервал между кликами (мс)

      let buffer = [];
      let gazeX  = window.innerWidth / 2;
      let gazeY  = window.innerHeight / 2;
      let lastBlinkTime = 0;

      // Обновляем при изменении размеров окна
      window.addEventListener('resize', () => {
        gazeX = window.innerWidth / 2;
        gazeY = window.innerHeight / 2;
      });

      // Основной цикл: двигаем точку, проверяем мигание
      function animate(ts) {
        // 1) Усреднение координат
        buffer.push({ x: gazeX, y: gazeY });
        if (buffer.length > BUFFER_SIZE) buffer.shift();
        const avg = buffer.reduce((p, c) => ({ x: p.x + c.x, y: p.y + c.y }), { x:0, y:0 });
        const avgX = avg.x / buffer.length;
        const avgY = avg.y / buffer.length;
        dot.style.transform = `translate(${avgX}px, ${avgY}px)`;

        // 2) Blink-click
        const tracker = webgazer.getTracker();
        if (tracker) {
          const pts = tracker.getCurrentPosition();
          if (pts && pts.length > 26) {
            // вычисляем EAR для одного глаза
            const [outer, inner, top, bottom] = [pts[23], pts[25], pts[24], pts[26]];
            const w = Math.hypot(outer[0] - inner[0], outer[1] - inner[1]);
            const h = Math.hypot(top[0]   - bottom[0],   top[1]   - bottom[1]);
            const ear = h / w;
            const now = performance.now();
            if (ear < BLINK_THRESHOLD && now - lastBlinkTime > BLINK_DEBOUNCE) {
              lastBlinkTime = now;
              const r = btn.getBoundingClientRect();
              if (avgX >= r.left && avgX <= r.right && avgY >= r.top && avgY <= r.bottom) {
                btn.click();
              }
            }
          }
        }

        requestAnimationFrame(animate);
      }

      // Запускаем WebGazer
      webgazer
        .setRegression('ridge')
        .setGazeListener(data => {
          if (data) {
            gazeX = data.x;
            gazeY = data.y;
          }
        })
        .begin()
        .then(() => {
          // скрываем оверлеи для скорости
          webgazer.showVideo(false);
          webgazer.showFaceOverlay(false);
          webgazer.showPredictionPoints(false);

          // старт цикла после инициализации
          requestAnimationFrame(animate);
        })
        .catch(e => console.error('Ошибка инициализации WebGazer:', e));

      // Визуальная реакция на клик
      btn.addEventListener('click', () => {
        btn.textContent = 'Нажато!';
        setTimeout(() => btn.textContent = 'Нажми меня взглядом', 800);
      });
    });
  </script>
</body>
</html>
