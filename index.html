<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0,user-scalable=no"/>
  <title>Ultra Eye-Control</title>
  <style>
    html, body {
      margin: 0; padding: 0;
      width: 100%; height: 100%; overflow: hidden;
      background: #000; position: relative;
    }
    /* Видео-поток и оверлей лица на весь экран, без отражения */
    #webgazerVideoFeed,
    #webgazerFaceOverlay {
      position: absolute !important;
      top: 0; left: 0 !important;
      width: 100vw !important; height: 100vh !important;
      transform: none !important;
      pointer-events: none; z-index: 1;
    }
    /* Скрываем точки предсказания WebGazer */
    .webgazerPredictionPoint {
      display: none !important;
    }
    /* Наша «точка взгляда» */
    #dot {
      position: absolute;
      width: 20px; height: 20px;
      margin: -10px 0 0 -10px;
      border-radius: 50%;
      background: lime;
      pointer-events: none;
      z-index: 10;
      will-change: transform;
    }
    /* Кнопка */
    #actionBtn {
      position: absolute;
      bottom: 40px;
      left: 50%;
      transform: translateX(-50%);
      padding: 15px 30px;
      font-size: 18px;
      border: none;
      border-radius: 8px;
      background: #1e90ff;
      color: #fff;
      z-index: 5;
      user-select: none;
    }
  </style>
</head>
<body>
  <button id="actionBtn">Нажми меня взглядом</button>
  <div id="dot"></div>

  <script src="https://webgazer.cs.brown.edu/webgazer.js"></script>
  <script>
    document.addEventListener('DOMContentLoaded', () => {
      const dot = document.getElementById('dot');
      const btn = document.getElementById('actionBtn');

      // Параметры
      const BUFFER_SIZE     = 4;     // Меньше = меньше задержка, но чуть больше дерганий
      const BLINK_THRESHOLD = 0.20;  // Порог EAR (отношение высоты/ширины)
      const BLINK_DEBOUNCE  = 500;   // Интервал между кликами (мс)

      let buffer = [];
      let gazeX  = window.innerWidth / 2;
      let gazeY  = window.innerHeight / 2;
      let lastBlinkTime = 0;

      // Адаптация под изменение экрана
      window.addEventListener('resize', () => {
        gazeX = window.innerWidth / 2;
        gazeY = window.innerHeight / 2;
      });

      // Основной цикл анимации и blink-click
      function animate(ts) {
        // 1) Усреднение координат для плавности
        buffer.push({ x: gazeX, y: gazeY });
        if (buffer.length > BUFFER_SIZE) buffer.shift();
        const sum = buffer.reduce((p, c) => ({ x: p.x + c.x, y: p.y + c.y }), { x: 0, y: 0 });
        const avgX = sum.x / buffer.length;
        const avgY = sum.y / buffer.length;
        dot.style.transform = `translate(${avgX}px, ${avgY}px)`;

        // 2) Blink-click по обоим глазам
        const tracker = webgazer.getTracker();
        if (tracker) {
          const pts = tracker.getCurrentPosition();
          if (pts && pts.length > 33) {
            // Данные по глазам (правый и левый)
            const eyes = [
              { outer: pts[23], inner: pts[25], top: pts[24], bottom: pts[26] },
              { outer: pts[30], inner: pts[32], top: pts[31], bottom: pts[33] }
            ];
            // Вычисляем EAR и берём минимальное для надёжности
            const ears = eyes.map(e => {
              const w = Math.hypot(e.outer[0] - e.inner[0], e.outer[1] - e.inner[1]);
              const h = Math.hypot(e.top[0]   - e.bottom[0],   e.top[1]   - e.bottom[1]);
              return h / w;
            });
            const ear = Math.min(...ears);
            const now = performance.now();
            if (ear < BLINK_THRESHOLD && now - lastBlinkTime > BLINK_DEBOUNCE) {
              lastBlinkTime = now;
              const r = btn.getBoundingClientRect();
              if (avgX >= r.left && avgX <= r.right && avgY >= r.top && avgY <= r.bottom) {
                btn.click();
              }
            }
          }
        }

        requestAnimationFrame(animate);
      }

      // Инициализация WebGazer
      webgazer
        .setRegression('ridge')         // регрессия Ridge
        .setTracker('clmtrackr')        // мощный трекер CLM
        .setGazeListener(data => {      // слушатель положения взгляда
          if (data) {
            gazeX = data.x;
            gazeY = data.y;
          }
        })
        .begin()
        .then(() => {
          // Показываем видео и оверлей лица в полноэкранном режиме
          webgazer.showVideo(true);
          webgazer.showFaceOverlay(true);
          webgazer.showPredictionPoints(false);
          // Старт основного цикла
          requestAnimationFrame(animate);
        })
        .catch(err => console.error('WebGazer init error:', err));

      // Визуальный отклик на клик
      btn.addEventListener('click', () => {
        btn.textContent = 'Нажато!';
        setTimeout(() => btn.textContent = 'Нажми меня взглядом', 800);
      });
    });
  </script>
</body>
</html>
